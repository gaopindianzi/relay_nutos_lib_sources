<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: TCP Sockets</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS&#160;<span id="projectnumber">4.10.1</span></div>
   <div id="projectbrief">API Reference</div>
  </td>
  <td>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('group__xg_tcp_socket.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>TCP Sockets</h1>  </div>
<div class="ingroups"><a class="el" href="group__xg_socket.html">Socket API</a></div></div>
<div class="contents">

<p>Application interface for TCP sockets.  
<a href="#_details">More...</a></p>
<div class="dynheader">
Collaboration diagram for TCP Sockets:</div>
<div class="dyncontent">
<center><table><tr><td><img src="group__xg_tcp_socket.png" border="0" alt="" usemap="#group____xg__tcp__socket"/>
<map name="group____xg__tcp__socket" id="group____xg__tcp__socket">
<area shape="rect" id="node2" href="group__xg_socket.html" title="Nut/Net Socket Interface." alt="" coords="5,5,85,30"/></map>
</td></tr></table></center>
</div>
<table class="memberdecls">
</table>
<p>Application interface for TCP sockets. </p>
<p>TCP clients typically use this order of API calls</p>
<ul>
<li>NutTcpCreateSocket()</li>
<li>NutTcpConnect()</li>
<li>NutTcpSend(), NutTcpReceive()</li>
<li>NutTcpCloseSocket()</li>
</ul>
<p>This is quite similar to the traditional Berkley TCP Socket API used on desktop PCs.</p>
<p>The order of API calls for TCP servers is</p>
<ul>
<li>NutTcpCreateSocket()</li>
<li>NutTcpAccept()</li>
<li>NutTcpSend(), NutTcpReceive()</li>
<li>NutTcpCloseSocket()</li>
</ul>
<p>Note, that this differs slightly from the Berkley API, where the initial socket is bound to a port and an additional socket is created when a connection is accepted. Nut/Net doesn't provide a bind call.</p>
<p>Most Nut/OS applications make use of the ability to assign a TCP socket to a stream and replace the somewhat primitive functions NutTcpSend() and NutTcpReceive() with stdio calls like fprintf() or fscanf(). </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"> #include &lt;stdio.h&gt;</span>
<span class="preprocessor"> #include &lt;sys/socket.h&gt;</span>

 ...

 TCPSOCKET *sock;
 FILE *stream;

 ...

 stream = _fdopen((<span class="keywordtype">int</span>) sock, <span class="stringliteral">&quot;r+b&quot;</span>);
 fprintf(stream, <span class="stringliteral">&quot;Hello peer\r\n&quot;</span>);
</pre></div><p>Remember, that Nut/OS streams are opened in text mode by default. Thus, we explicitly specify binary mode for the stream.</p>
<p>The application programmer can modify some default values of the TCP stack by calling NutTcpSetSockOpt(). This could be useful to fine tune the stack for maximum performance at minimum resource usage.</p>
<p>In addition you may call NutTcpSetSockOpt() to set a receive timeout in order to detect broken connections. That's often required, because TCP relies on a gracefully closed connection on the remote side. If the remote crashes or if the physical connection breaks, then NutTcpReceive() will never return unless a receive timeout value had been set. At least this is true for Nut/Net, which currently doesn't support the #SO_KEEPALIVE option.</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"> #include &lt;sys/socket.h&gt;</span>

 ...

 UDPSOCKET *sock;
 u_long tmo = 3000;
 <span class="keywordtype">int</span> rc;
 <span class="keywordtype">char</span> buff[128];

 ...

 NutTcpSetSockOpt(sock, SO_RCVTIMEO, &amp;tmo, <span class="keyword">sizeof</span>(tmo));

 ...

 rc = NutTcpReceive(sock, buff, <span class="keyword">sizeof</span>(buf));
 <span class="keywordflow">if</span> (rc == 0) {
     <span class="comment">/* </span>
<span class="comment">      * A timeout occured. We will now perform an application specific</span>
<span class="comment">      * action to check wether our remote is still alive.</span>
<span class="comment">      */</span>
 ...

 }
</pre></div><p>Note again the difference to the Berkley API, where select() is used to determine receive timeouts.</p>
<p>Most socket API calls return -1 in case of a failure. The function NutTcpError() can be used to query a more specific error code. </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor"> #include &lt;stdio.h&gt;</span>
<span class="preprocessor"> #include &lt;sys/socket.h&gt;</span>

 ...

 TCPSOCKET *sock;
 u_long ip = inet_addr(<span class="stringliteral">&quot;192.168.1.100&quot;</span>);
 u_short port = 20191;
 <span class="keywordtype">int</span> tcperr;

 ...

 <span class="keywordflow">if</span> (NutTcpConnect(sock, ip, port)) {
     tcperr = NutTcpError(sock);
     printf(<span class="stringliteral">&quot;TCP Error: &quot;</span>);
     <span class="keywordflow">switch</span>(tcperr) {
     <span class="keywordflow">case</span> EHOSTUNREACH:
         printf(<span class="stringliteral">&quot;No route to %s\n&quot;</span>, inet_ntoa(ip));
         <span class="keywordflow">break</span>;
     <span class="keywordflow">default</span>:
         printf(<span class="stringliteral">&quot;%d\n&quot;</span>, tcperr);
         <span class="keywordflow">break</span>;
     }
 }
</pre></div> </div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
